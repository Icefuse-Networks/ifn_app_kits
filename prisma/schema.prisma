// =============================================================================
// Icefuse Rust Dashboard - Database Schema
// =============================================================================
//
// MULTI-PLUGIN ARCHITECTURE
// -------------------------
// This schema supports multiple plugins (Kits, Clans, Stats, etc.)
// Each plugin has its own analytics/event tables following this pattern:
//
// 1. Core tables (shared across plugins):
//    - TokenCategory, ApiToken (API access)
//    - GameServer (server registry)
//    - AuditLog (mutation tracking)
//    - ServerIdentifierCategory, ServerIdentifier (plugin tracking)
//    - ServerWipe (wipe cycles)
//
// 2. Plugin-specific tables (follow this naming convention):
//    - {Plugin}Event (e.g., KitUsageEvent, ClanWarEvent, KillEvent)
//    - {Plugin}DailyStats (e.g., KitUsageDailyStats, ClanDailyStats)
//    - {Plugin}HourlyStats (e.g., KitUsageHourlyStats)
//    - {Plugin}GlobalStats (e.g., KitGlobalStats, PlayerGlobalStats)
//
// ADDING A NEW PLUGIN:
// 1. Create plugin-specific event table (see KitUsageEvent as template)
// 2. Create aggregation tables as needed (daily, hourly, global)
// 3. Register ID prefixes in src/lib/id.ts
// 4. Register scopes in src/types/api.ts
// 5. Register resource types in src/types/api.ts
// 6. Run prisma migrate to create tables
//
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// API Token Category - Organize tokens by plugin/purpose
// =============================================================================

model TokenCategory {
  id          String     @id @db.VarChar(60)
  name        String     @db.VarChar(100)
  description String?    @db.VarChar(255)
  color       String?    @db.VarChar(20)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  tokens ApiToken[]

  @@index([name])
  @@map("token_category")
}

// =============================================================================
// API Token - Programmatic access for plugins and automation
// =============================================================================

model ApiToken {
  id          String    @id @default(cuid())
  name        String    @db.VarChar(100)
  tokenHash   String    @unique @map("token_hash") @db.VarChar(64)
  tokenPrefix String    @map("token_prefix") @db.VarChar(8)
  scopes      String[]  @default(["kits:read"])
  createdBy   String    @map("created_by")
  categoryId  String?   @map("category_id") @db.VarChar(60)
  createdAt   DateTime  @default(now()) @map("created_at")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")

  category TokenCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([tokenHash])
  @@index([categoryId])
  @@map("api_token")
}

// =============================================================================
// Kit Configuration - Stores kit definitions as JSON
// =============================================================================

model KitConfig {
  id          String       @id @db.VarChar(60)
  name        String       @db.VarChar(100)
  description String?
  kitData     String       @map("kit_data")
  storeData   String?      @map("store_data")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  gameServers GameServer[]
  mappings    KitMapping[]

  // Analytics relations
  usageEvents      KitUsageEvent[]
  usageDailyStats  KitUsageDailyStats[]
  usageHourlyStats KitUsageHourlyStats[]
  globalStats      KitGlobalStats[]

  @@index([name])
  @@index([updatedAt])
  @@map("kit_config")
}

model KitMapping {
  id                 Int              @id @default(autoincrement())
  configId           String           @map("config_id") @db.VarChar(60)
  serverIdentifierId String           @map("server_identifier_id") @db.VarChar(60)
  isLive             Boolean          @default(false) @map("is_live")
  minutesAfterWipe   Int?             @map("minutes_after_wipe")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  config             KitConfig        @relation(fields: [configId], references: [id], onDelete: Cascade)
  serverIdentifier   ServerIdentifier @relation(fields: [serverIdentifierId], references: [id], onDelete: Cascade)

  @@unique([serverIdentifierId, minutesAfterWipe])
  @@index([configId])
  @@index([serverIdentifierId])
  @@map("kit_mappings")
}

// =============================================================================
// Game Server - Registry of game servers for kit deployment
// =============================================================================

model GameServer {
  id          Int        @id @default(autoincrement())
  categoryID  Int        @map("category_id")
  name        String     @db.VarChar(255)
  ip          String     @db.VarChar(45)
  port        Int
  imageUrl    String     @map("image_url")
  iconUrl     String     @map("icon_url")
  wipeConfig  String?    @map("wipe_config")
  botToken    String?    @map("bot_token") @db.VarChar(255)
  kitConfigId String?    @map("kit_config_id") @db.VarChar(60)
  kitConfig   KitConfig? @relation(fields: [kitConfigId], references: [id])
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Analytics relations
  wipes            ServerWipe[]
  usageEvents      KitUsageEvent[]
  usageDailyStats  KitUsageDailyStats[]
  usageHourlyStats KitUsageHourlyStats[]

  @@index([kitConfigId])
  @@map("game_server")
}

// =============================================================================
// Audit Log - Tracks all mutations for security and debugging
// =============================================================================

model AuditLog {
  id           String   @id @default(cuid())
  action       String   @db.VarChar(50)
  resourceType String   @map("resource_type") @db.VarChar(50)
  resourceId   String   @map("resource_id")
  actorType    String   @map("actor_type") @db.VarChar(20)
  actorId      String   @map("actor_id")
  oldValues    String?  @map("old_values")
  newValues    String?  @map("new_values")
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([resourceType, resourceId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_log")
}

// =============================================================================
// Server Identifier Category - Organize identifiers by purpose
// =============================================================================

model ServerIdentifierCategory {
  id          String   @id @db.VarChar(60)
  name        String   @db.VarChar(100)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  identifiers ServerIdentifier[]

  @@index([name])
  @@map("server_identifier_category")
}

// =============================================================================
// Server Identifier - Unique identifiers for plugin analytics
// =============================================================================

model ServerIdentifier {
  id              String    @id @db.VarChar(60)
  name            String    @db.VarChar(100)
  hashedId        String    @unique @map("hashed_id") @db.VarChar(60)
  description     String?   @db.VarChar(255)
  ip              String?   @db.VarChar(45)
  port            Int?
  connectEndpoint String?   @map("connect_endpoint") @db.VarChar(100)
  categoryId      String?   @map("category_id") @db.VarChar(60)
  playerData      Json?     @map("player_data")
  playerCount     Int       @default(0) @map("player_count")
  lastPlayerUpdate DateTime? @map("last_player_update")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  category      ServerIdentifierCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  usageEvents   KitUsageEvent[]
  lootMappings  LootMapping[]
  basesMappings BasesMapping[]
  kitMappings   KitMapping[]
  shopMappings  ShopMapping[]

  @@unique([ip, port])
  @@index([hashedId])
  @@index([categoryId])
  @@map("server_identifier")
}

// =============================================================================
// Analytics - Kit Usage Tracking
// =============================================================================

// Server Wipe - Tracks wipe cycles for per-wipe analytics
model ServerWipe {
  id               String    @id @db.VarChar(60)
  serverIdentifier String    @map("server_identifier") @db.VarChar(100)
  gameServerId     Int       @default(1) @map("game_server_id")
  wipeNumber       Int       @map("wipe_number")
  wipedAt          DateTime  @map("wiped_at")
  endedAt          DateTime? @map("ended_at")
  mapSeed          String?   @map("map_seed") @db.VarChar(20)
  mapSize          Int?      @map("map_size")
  createdAt        DateTime  @default(now()) @map("created_at")

  gameServer  GameServer      @relation(fields: [gameServerId], references: [id])
  usageEvents KitUsageEvent[]

  @@unique([serverIdentifier, wipeNumber])
  @@index([serverIdentifier, wipedAt])
  @@map("server_wipe")
}

// Kit Usage Event - Individual redemption records
model KitUsageEvent {
  id               String   @id @db.VarChar(60)
  eventId          String   @unique @map("event_id") @db.VarChar(64)

  // Kit info
  kitId            String   @map("kit_id") @db.VarChar(60)
  kitName          String   @map("kit_name") @db.VarChar(100)
  kitConfigId      String?  @map("kit_config_id") @db.VarChar(60)

  // Server info
  gameServerId         Int?     @map("game_server_id")
  serverIdentifier     String   @map("server_identifier") @db.VarChar(100)
  serverIdentifierId   String?  @map("server_identifier_id") @db.VarChar(60)
  wipeId               String?  @map("wipe_id") @db.VarChar(60)

  // Player info
  steamId          String   @map("steam_id") @db.VarChar(20)
  playerName       String?  @map("player_name") @db.VarChar(100)
  authLevel        Int      @default(0) @map("auth_level")

  // Usage context
  redemptionSource String   @map("redemption_source") @db.VarChar(30)
  wasSuccessful    Boolean  @default(true) @map("was_successful")
  failureReason    String?  @map("failure_reason") @db.VarChar(100)

  // Time-of-day for heat maps (UTC)
  hourOfDay        Int      @map("hour_of_day")
  dayOfWeek        Int      @map("day_of_week")

  // Kit metadata
  cooldownSeconds  Int?     @map("cooldown_seconds")
  itemCount        Int?     @map("item_count")

  // Timestamps
  redeemedAt       DateTime @map("redeemed_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  gameServer       GameServer?       @relation(fields: [gameServerId], references: [id])
  kitConfig        KitConfig?        @relation(fields: [kitConfigId], references: [id])
  wipe             ServerWipe?       @relation(fields: [wipeId], references: [id])
  serverIdent      ServerIdentifier? @relation(fields: [serverIdentifierId], references: [id])

  @@index([kitName, redeemedAt])
  @@index([serverIdentifierId])
  @@index([steamId, redeemedAt])
  @@index([gameServerId, redeemedAt])
  @@index([kitConfigId, redeemedAt])
  @@index([wipeId, redeemedAt])
  @@index([hourOfDay, dayOfWeek])
  @@index([redeemedAt])
  @@map("kit_usage_event")
}

// Daily aggregates for fast dashboard queries
model KitUsageDailyStats {
  id                    String   @id @db.VarChar(60)
  date                  DateTime @db.Date
  kitName               String   @map("kit_name") @db.VarChar(100)
  kitConfigId           String?  @map("kit_config_id") @db.VarChar(60)
  gameServerId          Int?     @map("game_server_id")
  wipeId                String?  @map("wipe_id") @db.VarChar(60)

  totalRedemptions      Int      @default(0) @map("total_redemptions")
  uniquePlayers         Int      @default(0) @map("unique_players")
  successfulRedemptions Int      @default(0) @map("successful_redemptions")
  failedRedemptions     Int      @default(0) @map("failed_redemptions")

  chatCommandCount      Int      @default(0) @map("chat_command_count")
  autoKitCount          Int      @default(0) @map("auto_kit_count")
  apiCallCount          Int      @default(0) @map("api_call_count")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  gameServer GameServer? @relation(fields: [gameServerId], references: [id])
  kitConfig  KitConfig?  @relation(fields: [kitConfigId], references: [id])

  @@unique([date, kitName, kitConfigId, gameServerId, wipeId])
  @@index([date])
  @@index([kitName])
  @@index([wipeId])
  @@map("kit_usage_daily_stats")
}

// Hourly heat map aggregates
model KitUsageHourlyStats {
  id               String   @id @db.VarChar(60)
  hourOfDay        Int      @map("hour_of_day")
  dayOfWeek        Int      @map("day_of_week")
  kitConfigId      String?  @map("kit_config_id") @db.VarChar(60)
  gameServerId     Int?     @map("game_server_id")

  totalRedemptions Int      @default(0) @map("total_redemptions")
  lastUpdated      DateTime @default(now()) @map("last_updated")

  gameServer GameServer? @relation(fields: [gameServerId], references: [id])
  kitConfig  KitConfig?  @relation(fields: [kitConfigId], references: [id])

  @@unique([hourOfDay, dayOfWeek, kitConfigId, gameServerId])
  @@map("kit_usage_hourly_stats")
}

// Global all-time kit statistics (never deleted)
model KitGlobalStats {
  id               String    @id @db.VarChar(60)
  kitName          String    @unique @map("kit_name") @db.VarChar(100)
  kitConfigId      String?   @map("kit_config_id") @db.VarChar(60)

  totalRedemptions Int       @default(0) @map("total_redemptions")
  uniquePlayers    Int       @default(0) @map("unique_players")
  lastRedeemed     DateTime? @map("last_redeemed")
  firstRedeemed    DateTime? @map("first_redeemed")

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  kitConfig KitConfig? @relation(fields: [kitConfigId], references: [id])

  @@index([totalRedemptions])
  @@map("kit_global_stats")
}

// =============================================================================
// CLANS PLUGIN MODELS
// =============================================================================

// Core Clan entity
model Clan {
  id          String   @id @db.VarChar(60) // Prefixed UUID: clan_<uuid>
  tag         String   @unique @db.VarChar(10) // Player-facing display tag (e.g., "IFN")
  description String?  @db.VarChar(200)
  tagColor    String   @default("5AF3F3") @map("tag_color") @db.VarChar(6)
  ownerId     String   @map("owner_id") @db.VarChar(20) // Steam ID
  flags       Int      @default(0) // ClanFlags bitfield
  version     Int      @default(0) // For optimistic locking / race condition prevention

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members       ClanMember[]
  roles         ClanRole[]
  invites       ClanInvite[]
  applications  ClanApplication[]
  alliancesFrom ClanAlliance[]    @relation("AllianceFrom")
  alliancesTo   ClanAlliance[]    @relation("AllianceTo")
  enemiesFrom   ClanEnemy[]       @relation("EnemyFrom")
  enemiesTo     ClanEnemy[]       @relation("EnemyTo")
  stats         ClanWipeStats?
  prestige      ClanPrestige?
  perks         ClanPerk[]

  @@index([tag])
  @@index([ownerId])
  @@map("clan")
}

// Clan member
model ClanMember {
  id       String    @id @db.VarChar(60) // clanmem_<uuid>
  clanId   String    @map("clan_id") @db.VarChar(60)
  steamId  String    @map("steam_id") @db.VarChar(20)
  roleRank Int       @default(2) @map("role_rank")
  joinedAt DateTime  @default(now()) @map("joined_at")
  lastOnline DateTime? @map("last_online")

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([clanId, steamId])
  @@index([steamId])
  @@map("clan_member")
}

// Clan custom role
model ClanRole {
  id          String @id @db.VarChar(60) // clanrole_<uuid>
  clanId      String @map("clan_id") @db.VarChar(60)
  rank        Int
  name        String @db.VarChar(20)
  color       String @default("888888") @db.VarChar(6)
  permissions Int    @default(0) // RolePermissions bitfield

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([clanId, rank])
  @@map("clan_role")
}

// Pending clan invite
model ClanInvite {
  id            String   @id @db.VarChar(60) // claninv_<uuid>
  clanId        String   @map("clan_id") @db.VarChar(60)
  targetSteamId String   @map("target_steam_id") @db.VarChar(20)
  invitedBy     String   @map("invited_by") @db.VarChar(20)
  expiresAt     DateTime @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([clanId, targetSteamId])
  @@index([targetSteamId])
  @@map("clan_invite")
}

// Clan join application
model ClanApplication {
  id               String   @id @db.VarChar(60) // clanapp_<uuid>
  clanId           String   @map("clan_id") @db.VarChar(60)
  applicantSteamId String   @map("applicant_steam_id") @db.VarChar(20)
  message          String?  @db.VarChar(200)
  appliedAt        DateTime @default(now()) @map("applied_at")

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([clanId, applicantSteamId])
  @@index([applicantSteamId])
  @@map("clan_application")
}

// Clan alliance (ally relationship)
model ClanAlliance {
  id         String    @id @db.VarChar(60) // clanally_<uuid>
  fromClanId String    @map("from_clan_id") @db.VarChar(60)
  toClanId   String    @map("to_clan_id") @db.VarChar(60)
  status     String    @default("pending") @db.VarChar(20) // pending, accepted
  createdAt  DateTime  @default(now()) @map("created_at")
  acceptedAt DateTime? @map("accepted_at")

  fromClan Clan @relation("AllianceFrom", fields: [fromClanId], references: [id], onDelete: Cascade)
  toClan   Clan @relation("AllianceTo", fields: [toClanId], references: [id], onDelete: Cascade)

  @@unique([fromClanId, toClanId])
  @@map("clan_alliance")
}

// Clan enemy relationship
model ClanEnemy {
  id         String   @id @db.VarChar(60) // clanenemy_<uuid>
  fromClanId String   @map("from_clan_id") @db.VarChar(60)
  toClanId   String   @map("to_clan_id") @db.VarChar(60)
  reason     String?  @db.VarChar(200) // Optional reason for enemy declaration
  declaredAt DateTime @default(now()) @map("declared_at")

  fromClan Clan @relation("EnemyFrom", fields: [fromClanId], references: [id], onDelete: Cascade)
  toClan   Clan @relation("EnemyTo", fields: [toClanId], references: [id], onDelete: Cascade)

  @@unique([fromClanId, toClanId])
  @@map("clan_enemy")
}

// Clan wipe stats (reset each wipe)
model ClanWipeStats {
  id                String   @id @db.VarChar(60) // clanstats_<uuid>
  clanId            String   @unique @map("clan_id") @db.VarChar(60)
  totalXP           Int      @default(0) @map("total_xp")
  pvpKills          Int      @default(0) @map("pvp_kills")
  pvpDeaths         Int      @default(0) @map("pvp_deaths")
  headshotKills     Int      @default(0) @map("headshot_kills")
  raidsCompleted    Int      @default(0) @map("raids_completed")
  npcKills          Int      @default(0) @map("npc_kills")
  heliKills         Int      @default(0) @map("heli_kills")
  bradleyKills      Int      @default(0) @map("bradley_kills")
  resourcesGathered BigInt   @default(0) @map("resources_gathered")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@map("clan_wipe_stats")
}

// Clan prestige (persists across wipes)
model ClanPrestige {
  id             String   @id @db.VarChar(60) // clanpres_<uuid>
  clanId         String   @unique @map("clan_id") @db.VarChar(60)
  prestigePoints Int      @default(0) @map("prestige_points")
  globalScore    Int      @default(0) @map("global_score")
  wipesSurvived  Int      @default(0) @map("wipes_survived")
  bestWipeLevel  Int      @default(0) @map("best_wipe_level")
  bestWipeRank   Int      @default(0) @map("best_wipe_rank")
  wipeWins       Int      @default(0) @map("wipe_wins")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@map("clan_prestige")
}

// Admin-defined perk definitions
model ClanPerkDefinition {
  id               String   @id @db.VarChar(60) // perkdef_<uuid>
  key              String   @unique @db.VarChar(50)
  name             String   @db.VarChar(100)
  description      String?  @db.VarChar(500)
  category         String   @db.VarChar(50) // capacity, resources, crafting, combat, economy, social
  levelRequired    Int      @default(1) @map("level_required")
  prestigeRequired Int      @default(0) @map("prestige_required") // 0 = Unranked
  effectType       String   @map("effect_type") @db.VarChar(50) // bonus_percent, flat_bonus, unlock
  effectValue      Float    @map("effect_value")
  sortOrder        Int      @default(0) @map("sort_order")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  clans ClanPerk[]

  @@index([category])
  @@map("clan_perk_definition")
}

// Clan's unlocked perks
model ClanPerk {
  id         String   @id @db.VarChar(60) // clanperk_<uuid>
  clanId     String   @map("clan_id") @db.VarChar(60)
  perkId     String   @map("perk_id") @db.VarChar(60)
  unlockedAt DateTime @default(now()) @map("unlocked_at")

  clan Clan               @relation(fields: [clanId], references: [id], onDelete: Cascade)
  perk ClanPerkDefinition @relation(fields: [perkId], references: [id], onDelete: Cascade)

  @@unique([clanId, perkId])
  @@map("clan_perk")
}

// =============================================================================
// GLOBAL CONTENT MODERATION
// =============================================================================

// Global banned word patterns - used by Clans, Chat Manager, and other plugins
model BannedWord {
  id        String   @id @db.VarChar(60) // bannedword_<uuid>
  pattern   String   @db.VarChar(200) // Exact match or regex pattern (longer for complex regex)
  isRegex   Boolean  @default(false) @map("is_regex") // If true, pattern is regex
  context   String   @default("all") @db.VarChar(50) // all, clan_tags, chat, player_names, etc.
  severity  Int      @default(3) // 1=mild, 2=moderate, 3=strong, 4=extreme
  category  String   @db.VarChar(50) // racial, lgbtq, sexual, profanity, hate_symbol, violence, etc.
  reason    String?  @db.VarChar(200)
  createdBy String   @map("created_by") @db.VarChar(20) // Admin Steam ID or "SYSTEM"
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([pattern, context])
  @@index([context])
  @@index([category])
  @@index([severity])
  @@map("banned_word")
}

// Legacy: Kept for migration, will be deprecated
model BannedClanName {
  id        String   @id @db.VarChar(60) // bannedname_<uuid>
  pattern   String   @unique @db.VarChar(50) // Exact match or regex pattern
  isRegex   Boolean  @default(false) @map("is_regex") // If true, pattern is regex
  reason    String?  @db.VarChar(200)
  createdBy String   @map("created_by") @db.VarChar(20) // Admin Steam ID
  createdAt DateTime @default(now()) @map("created_at")

  @@map("banned_clan_name")
}

// Clan event log for sync idempotency and audit trail
model ClanEvent {
  id               String   @id @db.VarChar(60) // clanevent_<uuid>
  eventId          String   @unique @map("event_id") @db.VarChar(64) // Idempotency key from plugin
  eventType        String   @map("event_type") @db.VarChar(50) // create, join, leave, kick, etc.
  clanId           String?  @map("clan_id") @db.VarChar(60)
  actorSteamId     String   @map("actor_steam_id") @db.VarChar(20)
  targetSteamId    String?  @map("target_steam_id") @db.VarChar(20)
  serverIdentifier String   @map("server_identifier") @db.VarChar(100)
  metadata         Json? // Additional event-specific data
  processedAt      DateTime @default(now()) @map("processed_at")

  @@index([clanId, processedAt])
  @@index([eventType, processedAt])
  @@map("clan_event")
}

// =============================================================================
// SERVER MANAGEMENT
// =============================================================================

model Server {
  id              Int      @id @default(autoincrement())
  name            String   @db.VarChar(255)
  ip              String   @db.VarChar(45)
  port            Int
  game            String   @db.VarChar(50)
  players         Int      @default(0)
  maxPlayers      Int      @default(200) @map("max_players")
  isActive        Boolean  @default(true) @map("is_active")
  battlemetricsId String?  @map("battlemetrics_id") @db.VarChar(50)
  imageUrl        String?  @map("image_url") @db.VarChar(500)
  wipeSchedule    String?  @map("wipe_schedule") @db.VarChar(255)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([ip, port])
  @@map("servers")
}

model ServerStats {
  id        Int      @id @default(autoincrement())
  serverId  Int      @map("server_id")
  players   Int      @default(0)
  timestamp DateTime @default(now())

  @@index([serverId, timestamp])
  @@map("server_stats")
}

// =============================================================================
// LOOT MANAGER
// =============================================================================

model LootConfig {
  id               Int                 @id @default(autoincrement())
  name             String              @db.VarChar(100)
  description      String?
  lootData         String              @map("loot_data")
  currentVersion   Int                 @default(1) @map("current_version")
  publishedVersion Int?                @map("published_version")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  versions         LootConfigVersion[]
  mappings         LootMapping[]

  @@index([name])
  @@map("loot_configs")
}

model LootMapping {
  id                 Int              @id @default(autoincrement())
  configId           Int              @map("config_id")
  serverIdentifierId String           @map("server_identifier_id") @db.VarChar(60)
  isLive             Boolean          @default(false) @map("is_live")
  minutesAfterWipe   Int?             @map("minutes_after_wipe")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  config             LootConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  serverIdentifier   ServerIdentifier @relation(fields: [serverIdentifierId], references: [id], onDelete: Cascade)

  @@unique([serverIdentifierId, minutesAfterWipe])
  @@index([configId])
  @@index([serverIdentifierId])
  @@map("loot_mappings")
}

model LootConfigVersion {
  id        Int        @id @default(autoincrement())
  configId  Int        @map("config_id")
  lootData  String     @map("loot_data")
  version   Int
  createdAt DateTime   @default(now()) @map("created_at")
  config    LootConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, version])
  @@index([configId])
  @@map("loot_config_versions")
}

model LootApiKey {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(64)
  name      String   @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("loot_api_keys")
}

// =============================================================================
// ICEFUSE BASES
// =============================================================================

model BasesConfig {
  id               Int                   @id @default(autoincrement())
  name             String                @db.VarChar(100)
  description      String?
  configData       String                @map("config_data")
  currentVersion   Int                   @default(1) @map("current_version")
  publishedVersion Int?                  @map("published_version")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")
  versions         BasesConfigVersion[]
  mappings         BasesMapping[]

  @@index([name])
  @@map("bases_configs")
}

model BasesMapping {
  id                 Int              @id @default(autoincrement())
  configId           Int              @map("config_id")
  serverIdentifierId String           @map("server_identifier_id") @db.VarChar(60)
  isLive             Boolean          @default(false) @map("is_live")
  minutesAfterWipe   Int?             @map("minutes_after_wipe")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  config             BasesConfig      @relation(fields: [configId], references: [id], onDelete: Cascade)
  serverIdentifier   ServerIdentifier @relation(fields: [serverIdentifierId], references: [id], onDelete: Cascade)

  @@unique([serverIdentifierId, minutesAfterWipe])
  @@index([configId])
  @@index([serverIdentifierId])
  @@map("bases_mappings")
}

model BasesConfigVersion {
  id         Int         @id @default(autoincrement())
  configId   Int         @map("config_id")
  configData String      @map("config_data")
  version    Int
  createdAt  DateTime    @default(now()) @map("created_at")
  config     BasesConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, version])
  @@index([configId])
  @@map("bases_config_versions")
}

model BasesFile {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  fileData  String   @map("file_data")
  fileSize  Int      @map("file_size")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([name])
  @@map("bases_files")
}

// =============================================================================
// ANNOUNCEMENTS
// =============================================================================

model Announcement {
  id                   Int                  @id @default(autoincrement())
  text                 String
  textEs               String?              @map("text_es")
  textFr               String?              @map("text_fr")
  textDe               String?              @map("text_de")
  textRu               String?              @map("text_ru")
  textZh               String?              @map("text_zh")
  textJa               String?              @map("text_ja")
  textPt               String?              @map("text_pt")
  textAr               String?              @map("text_ar")
  textKo               String?              @map("text_ko")
  textIt               String?              @map("text_it")
  delay                Int                  @default(0)
  isActive             Boolean              @default(true) @map("is_active")
  isGlobal             Boolean              @default(false) @map("is_global")
  showCardNotification Boolean              @default(false) @map("show_card_notification")
  cardDisplayDuration  Int?                 @map("card_display_duration")
  createdAt            DateTime             @default(now()) @map("created_at")
  updatedAt            DateTime             @updatedAt @map("updated_at")
  serverAssignments    AnnouncementServer[]

  @@index([isActive])
  @@index([isGlobal])
  @@map("announcements")
}

model AnnouncementServer {
  id             Int          @id @default(autoincrement())
  announcementId Int          @map("announcement_id")
  serverId       String       @map("server_id") @db.VarChar(191)
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, serverId])
  @@index([serverId])
  @@map("announcement_servers")
}

model Staff {
  id          BigInt   @id @default(autoincrement())
  when        DateTime @default(now())
  playerSid64 BigInt   @map("player_sid64")
  adminSid64  BigInt   @map("admin_sid64")
  group       String   @db.VarChar(50)

  @@index([playerSid64])
  @@index([group])
  @@map("staff")
}

// =============================================================================
// REDIRECT PLUGIN MODELS
// =============================================================================

model RedirectConfig {
  id                       String   @id @db.VarChar(60)
  staffGroups              String   @map("staff_groups")
  afkTimeSeconds           Int      @default(3600) @map("afk_time_seconds")
  checkInterval            Float    @default(30) @map("check_interval")
  configUpdateInterval     Float    @default(120) @map("config_update_interval")
  maxRedirectAttempts      Int      @default(3) @map("max_redirect_attempts")
  enableAFKRedirect        Boolean  @default(true) @map("enable_afk_redirect")
  minPlayersForEmptyServer Int      @default(0) @map("min_players_for_empty_server")
  maxPlayersForEmptyServer Int      @default(2) @map("max_players_for_empty_server")
  preferredEmptyServers    String   @map("preferred_empty_servers")
  excludedServers          String   @map("excluded_servers")
  enableWipeRedirect       Boolean  @default(true) @map("enable_wipe_redirect")
  wipeRedirectMinutesBefore Int     @default(2) @map("wipe_redirect_minutes_before")
  wipeRedirectMode         String   @default("current") @map("wipe_redirect_mode") @db.VarChar(20)
  wipeTargetServer         String?  @map("wipe_target_server") @db.VarChar(60)
  wipeHoldingServer        String?  @map("wipe_holding_server") @db.VarChar(60)
  wipeServerMapping        String   @default("{}") @map("wipe_server_mapping")
  overrideRedirectServer   String?  @map("override_redirect_server") @db.VarChar(60)
  isActive                 Boolean  @default(true) @map("is_active")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("redirect_config")
}

model WipeSchedule {
  id                 String   @id @db.VarChar(60)
  serverIdentifierId String   @map("server_identifier_id") @db.VarChar(60)
  dayOfWeek          Int      @map("day_of_week")
  hour               Int
  minute             Int
  wipeType           String   @default("regular") @map("wipe_type") @db.VarChar(20)
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([serverIdentifierId])
  @@index([dayOfWeek, hour, minute])
  @@map("wipe_schedule")
}

model RedirectLog {
  id               String   @id @db.VarChar(60)
  logType          String   @default("player") @map("log_type") @db.VarChar(20)
  playerName       String?  @map("player_name") @db.VarChar(255)
  steamId          String?  @map("steam_id") @db.VarChar(20)
  rank             String?  @db.VarChar(50)
  afkTimeSeconds   Float?   @map("afk_time_seconds")
  redirectReason   String   @map("redirect_reason") @db.VarChar(50)
  sourceIdentifier String   @map("source_identifier") @db.VarChar(100)
  targetIdentifier String?  @map("target_identifier") @db.VarChar(100)
  players          Int?
  outcome          String?  @db.VarChar(20)
  failureReason    String?  @map("failure_reason") @db.VarChar(200)
  timestamp        DateTime @default(now())
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([logType])
  @@index([rank])
  @@index([redirectReason])
  @@index([steamId])
  @@index([timestamp])
  @@index([sourceIdentifier])
  @@index([outcome])
  @@map("redirect_log")
}

model RedirectQueue {
  id                   String   @id @db.VarChar(60)
  sourceServerId       String   @map("source_server_id") @db.VarChar(60)
  targetServerId       String   @map("target_server_id") @db.VarChar(60)
  steamId              String   @map("steam_id") @db.VarChar(20)
  playerName           String?  @map("player_name") @db.VarChar(100)
  status               String   @default("pending") @db.VarChar(20)
  reason               String?  @db.VarChar(50)
  createdBy            String   @map("created_by") @db.VarChar(60)
  failureReason        String?  @map("failure_reason") @db.VarChar(200)
  processedAt          DateTime? @map("processed_at")
  createdAt            DateTime @default(now()) @map("created_at")

  @@index([sourceServerId, status])
  @@index([steamId])
  @@index([status])
  @@index([createdAt])
  @@map("redirect_queue")
}

// =============================================================================
// GIVEAWAY PLUGIN MODELS
// =============================================================================

model GiveawayPlayer {
  id              String   @id @db.VarChar(60)
  playerName      String   @map("player_name") @db.VarChar(255)
  playerSteamId64 String   @map("player_steam_id64") @db.VarChar(17)
  playTime        Float    @map("play_time")
  server          String   @db.VarChar(255)
  isWinner        Boolean  @default(false) @map("is_winner")
  giveawayId      String?  @map("giveaway_id") @db.VarChar(60)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  giveaway Giveaway? @relation(fields: [giveawayId], references: [id])

  @@index([createdAt])
  @@index([playerSteamId64])
  @@index([server])
  @@index([giveawayId])
  @@map("giveaway_player")
}

model Giveaway {
  id                  String    @id @db.VarChar(60)
  name                String    @db.VarChar(100)
  description         String?   @db.VarChar(500)
  isActive            Boolean   @default(false) @map("is_active")
  isGlobal            Boolean   @default(false) @map("is_global")
  minPlaytimeHours    Float     @default(2) @map("min_playtime_hours")
  maxWinners          Int       @default(1) @map("max_winners")
  startAt             DateTime? @map("start_at")
  endAt               DateTime? @map("end_at")
  winnerId            String?   @map("winner_id") @db.VarChar(60)
  winnerName          String?   @map("winner_name") @db.VarChar(255)
  winnerSteamId64     String?   @map("winner_steam_id64") @db.VarChar(17)
  endedAt             DateTime? @map("ended_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  players GiveawayPlayer[]
  servers GiveawayServer[]

  @@index([isActive])
  @@index([startAt, endAt])
  @@map("giveaway")
}

model GiveawayServer {
  id                 String   @id @db.VarChar(60)
  giveawayId         String   @map("giveaway_id") @db.VarChar(60)
  serverIdentifier   String   @map("server_identifier") @db.VarChar(100)
  createdAt          DateTime @default(now()) @map("created_at")

  giveaway Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)

  @@unique([giveawayId, serverIdentifier])
  @@index([serverIdentifier])
  @@map("giveaway_server")
}

// =============================================================================
// FEEDBACK PLUGIN MODELS
// =============================================================================

model Feedback {
  id               String    @id @db.VarChar(60)
  serverIdentifier String    @map("server_identifier") @db.VarChar(60)
  steamId          String    @map("steam_id") @db.VarChar(20)
  playerName       String    @map("player_name") @db.VarChar(100)
  category         String    @db.VarChar(50)
  responses        Json
  status           String    @default("pending") @db.VarChar(20)
  rewardAmount     Int?      @map("reward_amount")
  reviewedBy       String?   @map("reviewed_by") @db.VarChar(100)
  reviewedAt       DateTime? @map("reviewed_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  reward FeedbackReward?

  @@index([serverIdentifier, status])
  @@index([steamId])
  @@index([status])
  @@index([createdAt])
  @@map("feedback")
}

model FeedbackReward {
  id               String    @id @db.VarChar(60)
  feedbackId       String    @unique @map("feedback_id") @db.VarChar(60)
  serverIdentifier String    @map("server_identifier") @db.VarChar(60)
  steamId          String    @map("steam_id") @db.VarChar(20)
  playerName       String    @map("player_name") @db.VarChar(100)
  amount           Int
  status           String    @default("pending") @db.VarChar(20)
  processedAt      DateTime? @map("processed_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  feedback Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@index([serverIdentifier, status])
  @@index([steamId])
  @@index([status])
  @@map("feedback_reward")
}

// =============================================================================
// SHOP PLUGIN
// =============================================================================

model ShopConfig {
  id               Int                @id @default(autoincrement())
  name             String             @db.VarChar(100)
  description      String?
  categoriesData   String             @map("categories_data")
  itemsData        String             @map("items_data")
  currentVersion   Int                @default(1) @map("current_version")
  publishedVersion Int?               @map("published_version")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  versions         ShopConfigVersion[]
  mappings         ShopMapping[]

  @@index([name])
  @@map("shop_configs")
}

model ShopMapping {
  id                 Int              @id @default(autoincrement())
  configId           Int              @map("config_id")
  serverIdentifierId String           @map("server_identifier_id") @db.VarChar(60)
  isLive             Boolean          @default(false) @map("is_live")
  minutesAfterWipe   Int?             @map("minutes_after_wipe")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  config             ShopConfig       @relation(fields: [configId], references: [id], onDelete: Cascade)
  serverIdentifier   ServerIdentifier @relation(fields: [serverIdentifierId], references: [id], onDelete: Cascade)

  @@unique([serverIdentifierId, minutesAfterWipe])
  @@index([configId])
  @@index([serverIdentifierId])
  @@map("shop_mappings")
}

model ShopConfigVersion {
  id             Int        @id @default(autoincrement())
  configId       Int        @map("config_id")
  categoriesData String     @map("categories_data")
  itemsData      String     @map("items_data")
  version        Int
  createdAt      DateTime   @default(now()) @map("created_at")
  config         ShopConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@unique([configId, version])
  @@index([configId])
  @@map("shop_config_versions")
}

