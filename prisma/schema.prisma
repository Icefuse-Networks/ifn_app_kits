// =============================================================================
// Icefuse Kit Manager - Database Schema
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// API Token Category - Organize tokens by plugin/purpose
// =============================================================================

model TokenCategory {
  id          String     @id @db.VarChar(60)
  name        String     @db.VarChar(100)
  description String?    @db.VarChar(255)
  color       String?    @db.VarChar(20)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  tokens ApiToken[]

  @@index([name])
  @@map("token_category")
}

// =============================================================================
// API Token - Programmatic access for plugins and automation
// =============================================================================

model ApiToken {
  id          String    @id @default(cuid())
  name        String    @db.VarChar(100)
  tokenHash   String    @unique @map("token_hash") @db.VarChar(64)
  tokenPrefix String    @map("token_prefix") @db.VarChar(8)
  scopes      String[]  @default(["kits:read"])
  createdBy   String    @map("created_by")
  categoryId  String?   @map("category_id") @db.VarChar(60)
  createdAt   DateTime  @default(now()) @map("created_at")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")

  category TokenCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([tokenHash])
  @@index([categoryId])
  @@map("api_token")
}

// =============================================================================
// Kit Configuration - Stores kit definitions as JSON
// =============================================================================

model KitConfig {
  id          String       @id @db.VarChar(60)
  name        String       @db.VarChar(100)
  description String?
  kitData     String       @map("kit_data")
  storeData   String?      @map("store_data")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  gameServers GameServer[]

  // Analytics relations
  usageEvents      KitUsageEvent[]
  usageDailyStats  KitUsageDailyStats[]
  usageHourlyStats KitUsageHourlyStats[]
  globalStats      KitGlobalStats[]

  @@index([name])
  @@index([updatedAt])
  @@map("kit_config")
}

// =============================================================================
// Game Server - Registry of game servers for kit deployment
// =============================================================================

model GameServer {
  id          Int        @id @default(autoincrement())
  categoryID  Int        @map("category_id")
  name        String     @db.VarChar(255)
  ip          String     @db.VarChar(45)
  port        Int
  imageUrl    String     @map("image_url")
  iconUrl     String     @map("icon_url")
  wipeConfig  String?    @map("wipe_config")
  botToken    String?    @map("bot_token") @db.VarChar(255)
  kitConfigId String?    @map("kit_config_id") @db.VarChar(60)
  kitConfig   KitConfig? @relation(fields: [kitConfigId], references: [id])
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Analytics relations
  wipes            ServerWipe[]
  usageEvents      KitUsageEvent[]
  usageDailyStats  KitUsageDailyStats[]
  usageHourlyStats KitUsageHourlyStats[]

  @@index([kitConfigId])
  @@map("game_server")
}

// =============================================================================
// Audit Log - Tracks all mutations for security and debugging
// =============================================================================

model AuditLog {
  id           String   @id @default(cuid())
  action       String   @db.VarChar(50)
  resourceType String   @map("resource_type") @db.VarChar(50)
  resourceId   String   @map("resource_id")
  actorType    String   @map("actor_type") @db.VarChar(20)
  actorId      String   @map("actor_id")
  oldValues    String?  @map("old_values")
  newValues    String?  @map("new_values")
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([resourceType, resourceId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_log")
}

// =============================================================================
// Server Identifier - Unique identifiers for plugin analytics
// =============================================================================

model ServerIdentifier {
  id          String    @id @db.VarChar(60)
  name        String    @db.VarChar(100)
  hashedId    String    @unique @map("hashed_id") @db.VarChar(60)
  description String?   @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Analytics relation
  usageEvents KitUsageEvent[]

  @@index([hashedId])
  @@map("server_identifier")
}

// =============================================================================
// Analytics - Kit Usage Tracking
// =============================================================================

// Server Wipe - Tracks wipe cycles for per-wipe analytics
model ServerWipe {
  id               String    @id @db.VarChar(60)
  serverIdentifier String    @map("server_identifier") @db.VarChar(100)
  gameServerId     Int       @default(1) @map("game_server_id")
  wipeNumber       Int       @map("wipe_number")
  wipedAt          DateTime  @map("wiped_at")
  endedAt          DateTime? @map("ended_at")
  mapSeed          String?   @map("map_seed") @db.VarChar(20)
  mapSize          Int?      @map("map_size")
  createdAt        DateTime  @default(now()) @map("created_at")

  gameServer  GameServer      @relation(fields: [gameServerId], references: [id])
  usageEvents KitUsageEvent[]

  @@unique([serverIdentifier, wipeNumber])
  @@index([serverIdentifier, wipedAt])
  @@map("server_wipe")
}

// Kit Usage Event - Individual redemption records
model KitUsageEvent {
  id               String   @id @db.VarChar(60)
  eventId          String   @unique @map("event_id") @db.VarChar(64)

  // Kit info
  kitId            String   @map("kit_id") @db.VarChar(60)
  kitName          String   @map("kit_name") @db.VarChar(100)
  kitConfigId      String?  @map("kit_config_id") @db.VarChar(60)

  // Server info
  gameServerId         Int?     @map("game_server_id")
  serverIdentifier     String   @map("server_identifier") @db.VarChar(100)
  serverIdentifierId   String?  @map("server_identifier_id") @db.VarChar(60)
  wipeId               String?  @map("wipe_id") @db.VarChar(60)

  // Player info
  steamId          String   @map("steam_id") @db.VarChar(20)
  playerName       String?  @map("player_name") @db.VarChar(100)
  authLevel        Int      @default(0) @map("auth_level")

  // Usage context
  redemptionSource String   @map("redemption_source") @db.VarChar(30)
  wasSuccessful    Boolean  @default(true) @map("was_successful")
  failureReason    String?  @map("failure_reason") @db.VarChar(100)

  // Time-of-day for heat maps (UTC)
  hourOfDay        Int      @map("hour_of_day")
  dayOfWeek        Int      @map("day_of_week")

  // Kit metadata
  cooldownSeconds  Int?     @map("cooldown_seconds")
  itemCount        Int?     @map("item_count")

  // Timestamps
  redeemedAt       DateTime @map("redeemed_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  gameServer       GameServer?       @relation(fields: [gameServerId], references: [id])
  kitConfig        KitConfig?        @relation(fields: [kitConfigId], references: [id])
  wipe             ServerWipe?       @relation(fields: [wipeId], references: [id])
  serverIdent      ServerIdentifier? @relation(fields: [serverIdentifierId], references: [id])

  @@index([kitName, redeemedAt])
  @@index([serverIdentifierId])
  @@index([steamId, redeemedAt])
  @@index([gameServerId, redeemedAt])
  @@index([kitConfigId, redeemedAt])
  @@index([wipeId, redeemedAt])
  @@index([hourOfDay, dayOfWeek])
  @@index([redeemedAt])
  @@map("kit_usage_event")
}

// Daily aggregates for fast dashboard queries
model KitUsageDailyStats {
  id                    String   @id @db.VarChar(60)
  date                  DateTime @db.Date
  kitName               String   @map("kit_name") @db.VarChar(100)
  kitConfigId           String?  @map("kit_config_id") @db.VarChar(60)
  gameServerId          Int?     @map("game_server_id")
  wipeId                String?  @map("wipe_id") @db.VarChar(60)

  totalRedemptions      Int      @default(0) @map("total_redemptions")
  uniquePlayers         Int      @default(0) @map("unique_players")
  successfulRedemptions Int      @default(0) @map("successful_redemptions")
  failedRedemptions     Int      @default(0) @map("failed_redemptions")

  chatCommandCount      Int      @default(0) @map("chat_command_count")
  autoKitCount          Int      @default(0) @map("auto_kit_count")
  apiCallCount          Int      @default(0) @map("api_call_count")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  gameServer GameServer? @relation(fields: [gameServerId], references: [id])
  kitConfig  KitConfig?  @relation(fields: [kitConfigId], references: [id])

  @@unique([date, kitName, kitConfigId, gameServerId, wipeId])
  @@index([date])
  @@index([kitName])
  @@index([wipeId])
  @@map("kit_usage_daily_stats")
}

// Hourly heat map aggregates
model KitUsageHourlyStats {
  id               String   @id @db.VarChar(60)
  hourOfDay        Int      @map("hour_of_day")
  dayOfWeek        Int      @map("day_of_week")
  kitConfigId      String?  @map("kit_config_id") @db.VarChar(60)
  gameServerId     Int?     @map("game_server_id")

  totalRedemptions Int      @default(0) @map("total_redemptions")
  lastUpdated      DateTime @default(now()) @map("last_updated")

  gameServer GameServer? @relation(fields: [gameServerId], references: [id])
  kitConfig  KitConfig?  @relation(fields: [kitConfigId], references: [id])

  @@unique([hourOfDay, dayOfWeek, kitConfigId, gameServerId])
  @@map("kit_usage_hourly_stats")
}

// Global all-time kit statistics (never deleted)
model KitGlobalStats {
  id               String    @id @db.VarChar(60)
  kitName          String    @unique @map("kit_name") @db.VarChar(100)
  kitConfigId      String?   @map("kit_config_id") @db.VarChar(60)

  totalRedemptions Int       @default(0) @map("total_redemptions")
  uniquePlayers    Int       @default(0) @map("unique_players")
  lastRedeemed     DateTime? @map("last_redeemed")
  firstRedeemed    DateTime? @map("first_redeemed")

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  kitConfig KitConfig? @relation(fields: [kitConfigId], references: [id])

  @@index([totalRedemptions])
  @@map("kit_global_stats")
}
